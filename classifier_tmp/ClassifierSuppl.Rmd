---
title: "Endometrial Classifier - Supplementary Material"
output:
  html_document:
    css: ~/custom.css
  pdf_document: default
  word_document: default
---

```{r Preamble, message=FALSE,echo=FALSE,results='hide',warning=FALSE}
rm(list=ls(all=TRUE)) #Clean up
```

```{r Versions,message=FALSE,echo=FALSE,results='hide',warning=FALSE}
info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
```

```{r loadnMunge,message=FALSE,echo=FALSE,results='hide',warning=FALSE}

options(encoding = "UTF-8")
SETUP_KNITR.R <- "SetUp_knitr.R"
SETUP_TCGA <- "Setup_tcga.R"
CLASSIFIERFUNCTIONS.R <- "ClassifierFunctions.R"
CLASSIFIERMODELS.R <- "ClassifierModels.R"
SETUP_DB.R <- "SetUp_db.R"
CLASSIFICATION.CHART <- "classification.png" # CANNOT TAKE SPACE IN FILE PATH!!!!
TCGA.CLASSIFIER.DIAGRAM <- "tcga_classification.png"
TCGAMC.DIAGRAM  <- "TCGAMC.png"
TCGAAcc.DIAGRAM <- "TCGAAcc.png"
MC.DIAGRAM <- "MC.png"
USE.ALINE.PLOT <- TRUE
DO.CITATIONS=FALSE


source(SETUP_KNITR.R)
source(CLASSIFIERFUNCTIONS.R)
source(SETUP_DB.R) # setup database ... e.g. censoring, remove cases
source(SETUP_TCGA)

########################
### MANY TODO'S      ###
### need to fix them ###
########################

```

# Data Description- TCGA 
```{r TCGAtables,message=FALSE,echo=FALSE,results='asis',warning=FALSE}
class=TCGAfull$SUBTYPE 
vars=c("HISTOLOGICAL_SUBTYPE","TUMOR_STAGE_2009","GRADE") # c("HISTOLOGY","TUMOR_STAGE_2009","TUMOR_GRADE")
labels=c("Histotype","Stage","Grade") #
getTableData(TCGAfull,TCGAfull$SUBTYPE.SIMPLE.NAME,vars,contStatus=TRUE,labels,"Subtype/Stage/Grade by TCGA subtype")

vars2=c("POLE.mut.numeric","TP53.mut.numeric","PTEN.mut.numeric","MSI_STATUS_7_MARKER_CALL","SUBTYPE","CNA_CLUSTER_K4" ) 
Markdat=data.frame(lapply(TCGAfull[,vars2],as.character), stringsAsFactors=T); 
labels=c("POLE","P53","PTEN","MSI")
colnames(Markdat)=labels
getTableData(Markdat,TCGAfull$SUBTYPE.SIMPLE.NAME,labels,contStatus=TRUE,labels,"POLE/P53/PTEN/MSI mutation status by TCGA subtype")
```

- There are `r sum(TCGAfull$SUBTYPE.SIMPLE.NAME!="POLE"&TCGAfull$POLE.mut.numeric==1)` cases with POLE mutations that were not included in the POLE ultramutated subtype.
- There is `r sum(is.na(TCGAfull[,"MSI_STATUS_5_MARKER_CALL"]=="MSI-H"))` case(s) that did not have MSI status. In TCGA, those cases were classified if they had a high copy number.


# Data Description - BCCA cohort
## Follow-up
```{r Followup,message=FALSE,echo=FALSE,results='asis'}
source("remark6.R")
T1=as.Date(emdb[,"followup.start.date.mm.dd.yyyy"],format=DATE.FORMAT)
T2=as.Date(O$ev.Date) # no need to use do format=DATE.FORMAT since O$ev.Date should be date objects already
status=O$ev.status=="os.event"

FU=AssessSurvTime(T1,T2,status)
```
Patients entered the study between `r min(Year)` and `r max(Year)`. The table below calculates several measures to assess the median follow-up time for the cohort overall as well among the different `r CLASS.NAME` as classified by the pragmatic markers model: `r CLASS.CHOSEN.NAME` (`r sum(is.na(emdb[,CLASS.CHOSEN]))` cases not classifiable due to missing p53 IHC data).A detailed description of each can be found below that.

Please note, there was no event within the POLE group, therefore calculation of "censoring time" is not possible.


_Table of median follow-up time (in years)_

`r item6.fu.summary.table.os`
`r item6.fu.summary.table.dss`
`r item6.fu.summary.table.rfs`

1.  The observation time is computed as the difference between the final recorded date and the entry date of all patients.  This is also known as the follow-up time. 

2.  The censoring time is the follow-up time for censored patients or survivors. This is computed as the difference between the last recorded date and the entry date for censored events only.

3.	The time to end of study is computed as the difference between the date marked as the end of study date and the entry date for all patients. 

4.	The known function time is the difference between the end of study date and the entry date for those patients that are censored, and the difference between the study end date and the entry date for patients with events. This method is a hybrid between the observation time and the time to end of study and tends to over estimate the follow-up time.

5.	Kaplan Meier estimate of potential follow-up also known as the reverse Kaplan Meier method is calculated in the same way a KM estimate is calculated, but with the censoring variable reversed. Thus patients who have died are censored on their day of death, and the patients who are still alive have an event on the date they are censored. This allows the computation of the unobservable follow-up time which could have been potentially obtained for patients had they not died. This method is the most reliable and is considered the preferred choice in the literature `r if(DO.CITATIONS){citep("10.1016/0197-2456(96)00075-X")}`. 

The following table shows the number of events in the BCCA cohort and between the different categories of the pragmatic classifier model: `r CLASS.CHOSEN.NAME`.
```{r}
source("remark9.R")
```
`r item9.events.table$result.table.html`


# Variables Considered

**Clinicopathological Variables**:

- *Age at surgery* is calcuated as date of surgery - birth date.  

- *Body mass index (BMI)* is calculated from the weight and height data: weight (kg) / height (m)^2^

- *Stage* is coded as stage I, II, III and IV; In prognostic models, stage was analysed as stage I vs. {II, III or IV}

- *Grade*, coded as 1, 2 or 3. Grade was recoded and analyzed as {1 or 2} vs. 3 in association/correlation and survival analysis.

- *Histolological subtype* was recoded and was analyzed as endometrioid vs. non-endometrioid in association/correlation and survival analysis.  However, association tables will be shown for individual categories.  

- *Lymphovascular invasion (LVSI)* was captured as "Yes" if present and "No" otherwise. 

- *Any positive nodes* refers to any positive nodes either from pelvic or aortic.  For this variable, missing, includes cases where lymph node dissection was not performed.

- *Initial adjuvant treatment* was captured as start/end date of treatment and type of treatment (drug name for chemotherapy and location for radiation therapy).  This data is recoded as `r paste(names(table(emdb$init.treatment))[-1],collapse=", ")`.  Adjuvant treatment given before relapse was considered part of the initial treatment plan.  In cases with unknown relapse dates, adjuvant treatment was considered initial if the treatment was started within 90 days of surgery.  Initial adjuvant treatment was recoded for analysis as `r paste(names(table(emdb$any.init.treatment)), collapse=" vs. ")`. 


Finally for all dates computed in this study, going from days to years was achieved by dividing the number of days by 365.24 (http://en.wikipedia.org/wiki/Year).

**Clinical Classification (ESMO)**:

*Clinical risk groups* were assigned based on risk factors recorded in the study database.  Risk factors incluldes: grade 3, deep MI, stromal invasion of cervix, all non-endometrioid histologies.  The clinical risk group is assigned based on the following rule:
    - low: no risk factor
    - intermediate: one risk factor
    - high: more than one risk factor

Since the clinical risk group can be considered an ordinal variable (i.e. high > intermediate > low), it was fitted as a numeric variable (high=3, intermediate=2, low=1) in a Cox proportional hazard models.

**Molecular Classification (Pragmatic Classifier)**:

*Pragmatic classifier categories* were assigned using the chosen pragmatic classifier: `r CLASS.CHOSEN.NAME`. 


## Descriptive Table
```{r}
source("remark13.R")
```

`r item13.cohort.characteristics$result.table.html`

## Missing data Analysis
There are three reasons for data to be missing:

a. because of a condition was not tested in translational data.  

b. because some condition is not applicable. 		

c. because there aren't sufficient materials or assay failed, or clinician did not capture.

The analysis below is done on Category c only where applicable:

`r item13.cohort.missing$result.table.html`



# Model Comparison/ Internal Validation - TCGA
In the TCGA paper the following molecular classifier was proposed based on a full genome analysis:
  ![TCGA molecular](`r TCGA.CLASSIFIER.DIAGRAM`)

The POLE Ultra-mutated phenotype was first pulled out based on the presence of a POLE mutation and % C to A transversion greater than 0.2 and % C to G transversion smaller than 0.03. There were `r sum(is.na(TCGAfull$POLE.mut.numeric))` cases with missing POLE status those were carried through. The next group to be pulled out is the MSI high group. The MSI status was based on the seven marker NCI assay. The next group to be selected is the copy number high group. Copy number was done by clustering SNP6 data into four clusters and selecting the cluster with the highest average copy number (cluster 4) as copy number high. All the rest were put into a copy number low subtype category.
```{r message=FALSE,echo=FALSE,results='hide',fig.keep='all',fig.width=8, fig.height=6,warning=FALSE}
biostatUtil::doKMPlots(TCGAfull,"SUBTYPE","",line.color=CLASS.COLORS,surv.type="os",use.aline.plot=USE.ALINE.PLOT)
biostatUtil::doKMPlots(TCGAfull,"SUBTYPE","",line.color=CLASS.COLORS,surv.type="rfs",use.aline.plot=USE.ALINE.PLOT)
```

**Reproducing the TCGA subtypes**

(note: there is `r sum(is.na(TCGAfull[,MSI.VAR.NAME]))` case with missing MSI status and there are `r sum(is.na(TCGAfull$DFS_YEARS))` cases with unknown relapse time.)


```{r results='asis', fig.keep='all',fig.width=9, fig.height=3, warning=FALSE}
for(i in 1:nrow(TCGA.CLASS.NAMES)) {
  cat("<b>",paste("Proposed Classifier ",i,". ",TCGA.CLASS.NAMES[i,2],sep=""),"</b><br>")
  par(mfrow=c(1,3))
  # TODO: there is problem if use.aline.plot=TRUE
  biostatUtil::doKMPlots(TCGAfull,TCGA.CLASS.NAMES[i,1],"",line.color=CLASS.COLORS,surv.type="os", use.aline.plot=FALSE)
  biostatUtil::doKMPlots(TCGAfull,TCGA.CLASS.NAMES[i,1],"",line.color=CLASS.COLORS,surv.type="rfs",use.aline.plot=FALSE)
  par(mfrow=c(1,1))
  temp.d  <- TCGAfull[!is.na(TCGAfull[,TCGA.CLASS.NAMES[i,1]]),]
  p <- do.subtype.x.clin.risk.group.plot(temp.d, aes(temp.d[,TCGA.CLASS.NAMES[i,1]]), aes(fill = temp.d[,"ESMO.RISK.GROUP"]), paste(TCGA.CLASS.NAMES[i,2],"vs.",CLIN.RISK.GROUP.NAME))
  grid.arrange(p,ncol=1)
  # TODO: stat.tests should be "confusionMarkerAsRef", however, its currently not working doCohortCharacteristics
  cat(biostatUtil::doCohortCharacteristics(
    TCGAfull, "SUBTYPE.SIMPLE.NAME", "TCGA", c(TCGA.CLASS.NAMES[i,1]), c(FALSE), TCGA.CLASS.NAMES[i,2],
    stat.tests="chisq",num.boot.for.ci=NA,
    caption=paste("Agreement Proposed Classifier",i,"and",TCGA.CLASS.NAME.GOLD),marker.value.labels.tolower=FALSE,banded.rows=TRUE
  )$result.table.html)  
  cat("<br>")
}
```

```{r results='asis', fig.keep='all',fig.width=8, fig.height=6, warning=FALSE}
cat("<b>",TCGA.CLASS.NAME.GOLD,"</b><br>")
biostatUtil::doKMPlots(TCGAfull,"SUBTYPE.SIMPLE.NAME","",surv.type="os", use.aline.plot=USE.ALINE.PLOT)
biostatUtil::doKMPlots(TCGAfull,"SUBTYPE.SIMPLE.NAME","",surv.type="rfs",use.aline.plot=USE.ALINE.PLOT)
par(mfrow=c(1,1))
do.subtype.x.clin.risk.group.plot(TCGAfull, aes(TCGAfull[,"SUBTYPE.SIMPLE.NAME"]), aes(fill = TCGAfull[,"ESMO.RISK.GROUP"]), paste(TCGA.CLASS.NAME.GOLD,"vs.",CLIN.RISK.GROUP.NAME))
```

## `r CLIN.RISK.GROUP.NAME` ##

```{r results='asis', fig.keep='all',fig.width=8, fig.height=6, warning=FALSE}
# TODO: there is problem if use.aline.plot=TRUE
biostatUtil::doKMPlots(TCGAfull,"ESMO.RISK.GROUP","",surv.type="os", line.color=c("lightblue","orange","red"),use.aline.plot=FALSE)
biostatUtil::doKMPlots(TCGAfull,"ESMO.RISK.GROUP","",surv.type="rfs",line.color=c("lightblue","orange","red"),use.aline.plot=FALSE)
```

Model Comparison based on C-index computed with 1000 bootstrap samples:
  ![TCGA Model Comparison](`r TCGAMC.DIAGRAM`)

Sensitivity and Specificity to reprocude the TCGA subtypes based on 1000 bootstrap samples:
  ![TCGA Model Comparison](`r TCGAAcc.DIAGRAM`)


# Model Comparison/ Internal Validation - BCCA
**Classification Diagram Example**

![title](`r CLASSIFICATION.CHART`)

From the above diagram, for a particular classifier model, a case can be classifiable even if not all markers are intepretable.  For example, in the above model a case that is POLE mutated will be classified as POLE (ultramutated) even if all other pragmatic markers (MMR and p53) are uninterpretable. However, if POLE is uninterpretable, it will be unclassfiable even if other feature markers are.


**KM plots**

```{r results='asis', fig.keep='all',fig.width=9, fig.height=3, warning=FALSE}
for(i in 1:nrow(CLASS.NAMES)) {
  # TODO: there is problem if use.aline.plot=TRUE
  par(mfrow=c(1,3))
  biostatUtil::doKMPlots(emdb,CLASS.NAMES[i,1],paste(i,". ",CLASS.NAMES[i,2],"\n",sep=""),surv.type="os", line.color=CLASS.COLORS,use.aline.plot=FALSE)
  biostatUtil::doKMPlots(emdb,CLASS.NAMES[i,1],paste("\nDSS"),                            surv.type="dss",line.color=CLASS.COLORS,use.aline.plot=FALSE)
  biostatUtil::doKMPlots(emdb,CLASS.NAMES[i,1],paste("\nRFS"),                            surv.type="rfs",line.color=CLASS.COLORS,use.aline.plot=FALSE)
}
```

Model Comparison based on C-index computed with 1000 bootstrap samples:
  ![Model Comparison](`r MC.DIAGRAM`)

## Association of classifier categories with clinicopathological variables

Kruskal-Wallis rank sum test was used for continuous variables (age and BMI) and Fisher's exact test was used for all other variables (stage, grade, histology, LVSI, any positive nodes and initial adjuvant treatment). Kruskal-Wallis test address the question: whether the a continuous variable  is distributed evenly across the classifier categories. Fisher's exact test was used to assess the association between two nominal variables.

```{r}
source("remark14.R")
```
`r item14.correlation.table$result.table.html`

## Univariable association with clinical outcomes.

The Univariate association between survival time and the classifier categories as well as other prognostic variables cox proportional hazard regression (to assess effect size).  Significance testing was done using the likelihood ratio test.

```{r fig.keep='none'}
source("remark15.R")
```

**Univariable survival analysis -Cox Model**

*Please note: (F) indicates that the Firth's penalized maximum likelihood bias reduction method was used and the profile penalized log likelihood ratio test p-value is shown.*

`r uni.cox.summary.all.variables$result.table.html`

## Multivariable analyses

Univariable survival analysis was used to confirmed the validity of the classification by the pragmatic markers.

Subsequently, multivariable cox proportional hazard regression model analysis (with Firth's penalized maximum likelihood bias reduction) was performed to assess any additional prognostic information that would be added by this classifer beyond the clinical risk group classification and the standard prognostic factors (age, BMI, grade, stage, histology, LVSI, and treatment).  

P-value from likelihood ratio test in Cox models was reported.

For key multivariable analyses, report estimated effects (e.g. hazard ratio) with confidence intervals for the marker and, at least for the final model, all other variables in the model.

```{r fig.keep='none'}
source("remark16.R")
```

To assess any additional prognostic information added by the classifier model to clinicopathological parameters, two sets of multivariable analyses were performed.

1. multivariable analyses with clincial risk groups.
2. multivariable analyses with clinicopathological parameters: age, BMI, grade, stage, histology, LVSI.


**Clinical Classification (ESMO)**

Below we compare the clinical classification with the pragmatic molecular classifier model: `r CLASS.CHOSEN.NAME`

```{r message=FALSE,echo=FALSE,fig.height=8,fig.width=6,warning=FALSE}

format=theme(axis.title.x=element_text(size=15),legend.title=element_text(size=13),legend.text=element_text(size=13))
ggplot(emdb[!is.na(emdb[,CLASS.CHOSEN]),], aes(x=emdb[!is.na(emdb[,CLASS.CHOSEN]),CLASS.CHOSEN]))+ geom_bar(aes(fill = emdb$clin.path.risk.group[!is.na(emdb[,CLASS.CHOSEN])]),position='fill') +scale_fill_manual(name="Clinical\nRisk Groups",values = (brewer.pal(3, "Purples")))+ ggtitle("Clinical vs Molecular Classification")+ylab("")+ xlab("")+format

biostatUtil::doKMPlots(emdb,"clin.path.risk.group","",surv.type="os",line.color=c("lightblue","orange","red"),use.aline.plot=USE.ALINE.PLOT)
biostatUtil::doKMPlots(emdb,"clin.path.risk.group","",surv.type="dss",line.color=c("lightblue","orange","red"),use.aline.plot=USE.ALINE.PLOT)
biostatUtil::doKMPlots(emdb,"clin.path.risk.group","",surv.type="rfs",line.color=c("lightblue","orange","red"),use.aline.plot=USE.ALINE.PLOT)
```

`r multi.cox.summary.clin.risk.group.only$result.table.html`

**Clinicopathological parameters**

`r multi.cox.summary.all.variables$result.table.html`


**Exporatory analysis: `r CLASS.NAME.CNHIGH`/`r CLASS.NAME.CNLOW` markers comparison**

`r item16.p53mut.vs.ihc.vs.fish.whole$result.table.html`
`r item16.p53mut.vs.ihc.vs.fish.cn$result.table.html`

**Residual Assumptions**

```{r}
source("remark18.R")
```

In the basic form of the Cox regression model, the coefficients corresponded to the logarithm of the harzard ratio and were constant in time.  This assumption was graphically evaluated by means of smoothed Schoenfeld residual plots and tested as suggested by `r if(DO.CITATIONS){citep("10.1007/978-1-4757-3294-8")}`.

#### Schoenfeld residual plots ####

```{r message=FALSE,echo=FALSE,results='hide',fig.keep='all', fig.width=9, fig.height=3}
par(mfrow=c(1,3))
do.check.ph(emdb, CLASS.CHOSEN, paste("classifier model: ",CLASS.CHOSEN.NAME,sep=""), ref.group=CLASS.NAME.REFERENCE)
```

Visual examination of the Schoenfeld residual plots indicate no evidence of classifier model (`r CLASS.CHOSEN.NAME`) violating the proportional hazard assumption.
