---
title: "POLE Remark Criteria - Additional Analysis"
output:
  html_document:
    css: ~/custom.css
  pdf_document: default
  word_document: default
---


```{r Preamble, message=FALSE,echo=FALSE,warning=FALSE,results='hide'}
# markdown manual: http://rmarkdown.rstudio.com/authoring_basics.html
rm(list=ls(all=TRUE)) #Clean up
```

```{r Versions,message=FALSE,echo=FALSE,results='hide',warning=FALSE}
info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
```

```{r input_constants,message=FALSE,echo=FALSE,results='hide',warning=FALSE}
RUN.IN.MARKDOWN=TRUE # a flag to indicate that the codes are called from this markdown file
options(encoding = "UTF-8")
LIB.DIR <- "R_scripts/"
SETUP_KNITR.R <- paste(LIB.DIR,"SetUp_knitr.R",sep="")
DEFINEEVENTDATE.R <- paste(LIB.DIR,"DefineEventDate.R",sep="")
ED.CSV <- "data/endometrial_n518_2015-05-21.csv"
SETUP_DB.R <- "SetUp_db.R"
DATE.FORMAT="%m/%d/%Y" # this should be R's default date format
CASE.SELECTION.FLOW.CHART <- "images/remark.png" # CANNOT TAKE SPACE IN FILE PATH!!!!
DO.CITATIONS=FALSE

options(scipen=999) # disable scientific notation e.g. instead of 1x10E-3, show 0.001
```


```{r loadnMunge,message=FALSE,echo=FALSE,results='hide',warning=FALSE}
library(dplyr)
require(Gmisc)
library(survival)
library(knitcitations)
library(powerSurvEpi)
source(SETUP_KNITR.R)
source(DEFINEEVENTDATE.R)
source(SETUP_DB.R) # setup database ... e.g. censoring, remove cases

```

#### Item 13 (additional). Report distributions of basic demographic characteristics, standard prognostic variables, and tumor marker, including numbers of missing values.

#### Treatment Trend
Tabulate the proportion of patients receiving different types of initial adjuvant treatment and observe any trend changes over the years. 

```{r}
source("treatment_trend.R")
```



```{r message=FALSE,echo=FALSE,results='hide',fig.keep='all', fig.width=10, fig.height=6}
do.treatment.trend.barplot(
  emdb[!emdb$init.treatment%in%ALL.MISSING.CODES,],
  title=paste("Adjuvant treatment, whole cohort\n(",sum(emdb$init.treatment%in%ALL.MISSING.CODES)," cases with missing data)",sep=""),
  legend.space=0.2
)
do.treatment.trend.barplot(
  emdb[!emdb$init.treatment%in%ALL.MISSING.CODES & emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED,],
  title=paste("Adjuvant treatment, among POLE mutated\n(",sum(emdb$init.treatment[emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED]%in%ALL.MISSING.CODES)," case with missing data)",sep=""),
  legend.space=0.2
)

obs.yrs <- 5
do.survival.trend.barplot(
  emdb[emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED,],
  paste(obs.yrs,"-years overall survival, among POLE mutated\n(no missing data)",sep=""), 
  "os.yrs", 
  "os.sts", 
  "os.event", 
  "dead", 
  "alive", obs.yrs=obs.yrs, legend.space=0.2)
do.survival.trend.barplot(
  emdb[!is.na(emdb$dss.yrs) & emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED,],
  paste(obs.yrs,"-years disease specific survival, among POLE mutated\n(",sum(is.na(emdb$dss.yrs[emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED]))," case with missing data)",sep=""), 
  "dss.yrs", 
  "dss.sts", 
  "dss.event", 
  "died of disease", 
  "died of other cause or alive", obs.yrs=obs.yrs, legend.space=0.2)
do.survival.trend.barplot(
  emdb[!is.na(emdb$rfs.yrs) & emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED,],
  paste(obs.yrs,"-years relapse free survival, among POLE mutated\n(",sum(is.na(emdb$rfs.yrs[emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED]))," cases with missing data)",sep=""), 
  "rfs.yrs", 
  "rfs.sts", 
  "rfs.event", 
  "relapsed", 
  "no recurrence", obs.yrs=obs.yrs, legend.space=0.2)
do.grade.trend.barplot(
  emdb[emdb$POLE.mut.germline.as.missing==VALUE.CODING.MUTATED,],
  title=paste("Grade, among POLE mutated\n(no missing data)",sep=""),
  legend.space=0.2)
```



#### Item 14 (additional). Show the relation of the marker to standard prognostic variables.
```{r message=FALSE,echo=FALSE,results='hide'}
source("remark14.R")
```

#### Logistic Regression Model: POLE ~ clincopathological parameters

Multivariable logistic regression models was used to assess which clinicopathological parameters are most significantly associated with POLE mutation status.

**Model with BMI (GLM)**

Due to lack of cases, the "perfect or quasi perfect separation" problem was encountered when logistic regression model was fitted using glm.  
```{r}
summary(logit.full)$coefficients
```

Stepwise model selection using AIC (R function step() on glm() fit object) ...

```{r}
anova(logit.full.reduced,test="LRT")
```

**Model with BMI (FIRTH)**
```{r}
logit.full.firth
```

Backward model selection (backward() function from logistf package) ...

```{r}
logit.full.firth.reduced
```


**Model excluding BMI (GLM)**
```{r}
summary(logit.full.ex.bmi)$coefficients
```

Stepwise model selection using AIC (R function step() on glm() fit object) ...

```{r}
anova(logit.full.ex.bmi.reduced,test="LRT")
```

**Model excluding BMI (FIRTH)**
```{r}
print.logistf.fit(logit.full.ex.bmi.firth)
```

Backward model selection (backward() function from logistf package) ...

```{r}
logit.full.ex.bmi.firth.reduced
```


**Summary of logistic regression analysis**

- Model with BMI shows age, BMI and stage significantly (both glm and logistf) associated with POLE mutation status.
- Model excluding BMI shows age and stage significantly (both glm and logistf) associated with POLE mutation status.

**Cross tabulation tables ...**

```{r}
# want to see POLE x (stage x age)
options(table_counter=0)
pole_vs_stage_x_age <- do.cohort.characteristics(emdb, "POLE.mut.germline.as.missing", "POLE", 
  	c("stage_x_age"), 
		c(FALSE), 
		c("Stage x age"),
		stat.tests=c("fisher"),
		show.missing=TRUE,
		missing.codes.highlight=NULL, #missing.codes.highlights,
		missing.codes=ALL.MISSING.CODES, # want to show missing in percentages
		caption="POLE vs. Stage x Age",
		banded.rows=TRUE
)
# want to see POLE x (stage x bmi)
pole_vs_stage_x_bmi <- do.cohort.characteristics(emdb, "POLE.mut.germline.as.missing", "POLE", 
    c("stage_x_bmi"), 
		c(FALSE), 
		c("Stage x BMI"),
		stat.tests=c("fisher"),
		show.missing=TRUE,
		missing.codes.highlight=NULL, #missing.codes.highlights,
		missing.codes=ALL.MISSING.CODES, # want to show missing in percentages
		caption="POLE vs. Stage x BMI",
		banded.rows=TRUE
)
# want to see POLE x (age x bmi)
pole_vs_age_x_bmi <- do.cohort.characteristics(emdb, "POLE.mut.germline.as.missing", "POLE", 
    c("age_x_bmi"), 
  	c(FALSE), 
		c("Age x BMI"),
		stat.tests=c("fisher"),
		show.missing=TRUE,
		missing.codes.highlight=NULL, #missing.codes.highlights,
		missing.codes=ALL.MISSING.CODES, # want to show missing in percentages
		caption="POLE vs. age x BMI",
		banded.rows=TRUE
)
# want to see POLE x (stage x age x bmi)
pole_vs_stage_x_age_x_bmi <- do.cohort.characteristics(emdb, "POLE.mut.germline.as.missing", "POLE", 
    c("stage_x_age_x_bmi"), 
  	c(FALSE), 
		c("Stage x age x BMI"),
		stat.tests=c("fisher"),
		show.missing=TRUE,
		missing.codes.highlight=NULL, #missing.codes.highlights,
		missing.codes=ALL.MISSING.CODES, # want to show missing in percentages
		caption="POLE vs. Stage x age x BMI",
		banded.rows=TRUE
)
```

`r pole_vs_stage_x_age$result.table.html`
`r pole_vs_stage_x_bmi$result.table.html`
`r pole_vs_age_x_bmi$result.table.html`
`r pole_vs_stage_x_age_x_bmi$result.table.html`

#### Item 15 (additional). Present univariable analyses showing the relation between the marker and outcome, with the estimated effect.  Preferrably provide similar analyses for all other variables being analyzed.

**Analysis among grade 3**

```{r fig.keep='none'}
source("remark15.R")

```{r message=FALSE,echo=FALSE,results='hide',fig.keep='all', fig.width=8, fig.height=6}
# width/height = 13/5
  do.km.plots(
		emdb[!emdb$POLE.mut.germline.as.missing%in%ALL.MISSING.CODES & emdb$Tumour.Grade=="Grade 3",],
		"POLE.mut.germline.as.missing", 
		"POLE mutation status - grade 3",
		single.test.type="logrank",
		surv.type="os",
		conf.int=TRUE, # per missing 2015-01-09 ... wanted confidence interval on KM plots
		use.aline.plot=TRUE
	)
  do.km.plots(
  	emdb[!emdb$POLE.mut.germline.as.missing%in%ALL.MISSING.CODES & emdb$Tumour.Grade=="Grade 3",],
		"POLE.mut.germline.as.missing", 
    "POLE mutation status - grade 3",
		single.test.type="logrank",
		surv.type="dss",
		conf.int=TRUE,
		use.aline.plot=TRUE
	)
  do.km.plots(
  	emdb[!emdb$POLE.mut.germline.as.missing%in%ALL.MISSING.CODES & emdb$Tumour.Grade=="Grade 3",],
		"POLE.mut.germline.as.missing", 
		"POLE mutation status - grade 3",
		single.test.type="logrank",
		surv.type="rfs",
		conf.int=TRUE, # per missing 2015-01-09 ... wanted confidence interval on KM plots
		use.aline.plot=TRUE
	)

options(table_counter=4)
uni.cox.pole.g3 <- do.coxph.generic( # a table of univariable cox models of treatment vs. no treatment
  	emdb[emdb$Tumour.Grade=="Grade 3",], 
		c("POLE.mut.germline.as.missing"), 
		c("POLE mutation status<br>wild type=0/mutated=1"),
		use.firth=FIRTH.THRESHOLD,
		stat.test="logtest",
		var.ref.groups=c(POLE.REF.GROUP),
		caption="Univariable analyses of relation of POLE mutation status to OS/DSS/RFS among patients with grade 3 tumors",
		banded.rows=TRUE)
multi.cox.summary.g3 <- do.coxph.multivariable( 
    emdb[emdb$Tumour.Grade=="Grade 3",], 
	c(
		"POLE.mut.germline.as.missing",
		"age.at.surgery",
		"stage_b1v234",
		"Histological.Subtype_non_endo",
		"LVSI",
		"any.positive.nodes",
		"any.init.treatment"
	), 
	c(
		HTML.COX.VAR.DESC.POLE,
		HTML.COX.VAR.DESC.AGE,
		HTML.COX.VAR.DESC.STAGE,
		HTML.COX.VAR.DESC.HIST,
		HTML.COX.VAR.DESC.LVSI,
		HTML.COX.VAR.DESC.ANY.POS.NODES,
		HTML.COX.VAR.DESC.ANY.INIT.ADJ.TX
	),
	use.firth=FIRTH.THRESHOLD, 
	stat.test="logtest",
	var.ref.groups=c(POLE.REF.GROUP,NA,NA,NA,NA,NA,NA),
	caption=paste("Multivariable analyses of POLE (exclude BMI) among grade 3",sep=""),
	banded.rows=TRUE
)

```

*Please note: (F) indicates that the Firth's penalized maximum likelihood bias reduction method was used to estimate the hazard ratio.*

`r uni.cox.pole.g3$result.table.html`
`r multi.cox.summary.g3$result.table.html`

There is a discrepancy between likelihood ratio test (table 6) and the P-values from Wald test (not shown, but implied by the reported hazard ratio confidence interval in table 6.  i.e. we expected to see the confidence interval to not cross "1"" for all parameters with likelihood ratio test p-values < 0.05).  Steve McKinney suggested a bootstrap analysis be performed to observe how the hazard ratio will be distributed on bootstrap samples.  For example, if 97.5% of the hazard ratios obtained from bootstrap samples are above "1", we will be able to say that the hazard ratio is significantly greater than "1", p=0.05.

*Bootstrap analysis - hazard ratio from Cox regression models with Firth's penalized likelihood*

```{r message=FALSE,echo=FALSE,results='hide'}
source("remark17.R")
```

Number of bootstrap samples: `r num.boot`

`r kable(boot.hrs.os.table, align='c',caption=paste('Table 7. Median (overall survival) hazard ratio and 95% CI among',num.boot,'bootstrap samples'))`
`r kable(boot.hrs.dss.table,align='c',caption=paste('Table 8. Median (disease specific survival) hazard ratio and 95% CI among',num.boot,'bootstrap samples'))`
`r kable(boot.hrs.rfs.table,align='c',caption=paste('Table 9. Median (progression free survival) hazard ratio and 95% CI among',num.boot,'bootstrap samples'))`

```{r message=FALSE,echo=FALSE,results='hide',fig.keep='all', fig.width=9, fig.height=3}
par(mfrow=c(1,3))
hist(as.numeric(boot.hrs.os[ ,"POLE.mut.consolidated.numeric"]),main=paste("Overall survival\n(n=",sum(!is.na(boot.hrs.os[ ,"POLE.mut.consolidated.numeric"])),")",sep=""), xlab="log hazard ratio on bootstrap samples")
hist(as.numeric(boot.hrs.dss[,"POLE.mut.consolidated.numeric"]),main=paste("Disease specific survival\n(n=",sum(!is.na(boot.hrs.dss[ ,"POLE.mut.consolidated.numeric"])),")",sep=""), xlab="log hazard ratio on bootstrap samples")
hist(as.numeric(boot.hrs.rfs[,"POLE.mut.consolidated.numeric"]),main=paste("Progression free survival\n(n=",sum(!is.na(boot.hrs.rfs[ ,"POLE.mut.consolidated.numeric"])),")",sep=""), xlab="log hazard ratio on bootstrap samples")
```